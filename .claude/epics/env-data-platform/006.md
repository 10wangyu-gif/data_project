---
name: API服务平台
status: open
created: 2025-09-16T08:20:41Z
updated: 2025-09-16T08:20:41Z
github: [Will be updated when synced to GitHub]
depends_on: [002, 005]
parallel: true
conflicts_with: []
---

# API服务平台

## 概述
构建企业级API服务平台，提供数据API的自动化生成、完整的文档管理系统和细粒度的权限控制机制，将数据资产快速转化为可调用的API服务。

## 核心功能

### 1. API自动生成
- **基于数据源的API生成**
  - 数据库表自动生成CRUD API
  - 视图查询API快速创建
  - 自定义SQL查询API包装
  - 文件数据API接口生成

- **API配置和定制**
  - 字段筛选和映射配置
  - 查询参数验证规则
  - 响应格式自定义
  - 缓存策略配置

### 2. API文档管理
- **OpenAPI/Swagger集成**
  - 自动生成API文档
  - 交互式文档界面
  - 在线API测试工具
  - 代码示例生成

- **文档版本管理**
  - API版本控制
  - 变更历史追踪
  - 文档发布管理
  - 废弃API标记

### 3. 权限控制系统
- **多层次权限管理**
  - 用户级别权限控制
  - 角色权限模板
  - API级别访问控制
  - 数据行级权限过滤

- **访问控制策略**
  - API密钥认证
  - OAuth 2.0集成
  - IP白名单限制
  - 访问频率限制

## 技术架构

### API网关设计
```java
// API网关核心组件
@Component
public class APIGateway {
    @Autowired
    private AuthenticationService authService;

    @Autowired
    private AuthorizationService authzService;

    @Autowired
    private RateLimitService rateLimitService;

    @Autowired
    private CacheService cacheService;

    // API请求处理
    public ResponseEntity<Object> processRequest(APIRequest request) {
        // 1. 认证检查
        AuthenticationResult auth = authService.authenticate(request);
        if (!auth.isSuccess()) {
            return ResponseEntity.status(401).build();
        }

        // 2. 授权检查
        if (!authzService.authorize(auth.getUser(), request.getApiPath())) {
            return ResponseEntity.status(403).build();
        }

        // 3. 限流检查
        if (!rateLimitService.allowRequest(auth.getUser(), request.getApiPath())) {
            return ResponseEntity.status(429).build();
        }

        // 4. 缓存检查
        Object cachedResult = cacheService.get(request.getCacheKey());
        if (cachedResult != null) {
            return ResponseEntity.ok(cachedResult);
        }

        // 5. 执行API逻辑
        return executeAPI(request);
    }
}
```

### 动态API生成器
```java
// API定义模型
@Entity
@Table(name = "api_definitions")
public class APIDefinition {
    @Id
    private Long id;

    private String name;                // API名称
    private String path;                // API路径
    private String method;              // HTTP方法
    private String description;         // API描述
    private APIType type;               // API类型

    @Column(columnDefinition = "JSON")
    private String dataSourceConfig;    // 数据源配置

    @Column(columnDefinition = "JSON")
    private String parameters;          // 参数定义

    @Column(columnDefinition = "JSON")
    private String responseSchema;      // 响应结构

    @Column(columnDefinition = "JSON")
    private String securityConfig;      // 安全配置

    private APIStatus status;           // API状态
    private String version;             // API版本
}

// 动态API执行器
@Service
public class DynamicAPIExecutor {

    // 执行数据库查询API
    public Object executeTableAPI(APIDefinition apiDef, Map<String, Object> params) {
        TableAPIConfig config = JsonUtils.fromJson(apiDef.getDataSourceConfig(), TableAPIConfig.class);

        // 构建SQL查询
        QueryBuilder queryBuilder = new QueryBuilder(config.getTableName());
        applyFilters(queryBuilder, params, config.getFilters());
        applyPagination(queryBuilder, params);

        // 执行查询
        return jdbcTemplate.query(queryBuilder.build(), new BeanPropertyRowMapper<>());
    }

    // 执行自定义SQL API
    public Object executeCustomSQLAPI(APIDefinition apiDef, Map<String, Object> params) {
        CustomSQLConfig config = JsonUtils.fromJson(apiDef.getDataSourceConfig(), CustomSQLConfig.class);

        // 参数绑定和安全检查
        String sql = bindParameters(config.getSqlTemplate(), params);
        validateSQL(sql);

        return jdbcTemplate.query(sql, new MapRowMapper());
    }
}
```

## 数据库设计

### API管理表
```sql
-- API定义表
CREATE TABLE api_definitions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL COMMENT 'API名称',
    path VARCHAR(200) NOT NULL COMMENT 'API路径',
    method ENUM('GET', 'POST', 'PUT', 'DELETE') NOT NULL COMMENT 'HTTP方法',
    description TEXT COMMENT 'API描述',
    type ENUM('TABLE', 'CUSTOM_SQL', 'FILE', 'AGGREGATION') NOT NULL COMMENT 'API类型',
    data_source_id BIGINT COMMENT '数据源ID',
    data_source_config JSON NOT NULL COMMENT '数据源配置',
    parameters JSON COMMENT '参数定义',
    response_schema JSON COMMENT '响应结构定义',
    security_config JSON COMMENT '安全配置',
    cache_config JSON COMMENT '缓存配置',
    status ENUM('DRAFT', 'ACTIVE', 'DEPRECATED', 'DISABLED') DEFAULT 'DRAFT',
    version VARCHAR(20) DEFAULT '1.0.0' COMMENT 'API版本',
    owner_id BIGINT NOT NULL COMMENT '所有者ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_path_method_version (path, method, version),
    INDEX idx_owner_id (owner_id),
    INDEX idx_status (status),
    INDEX idx_data_source (data_source_id)
);

-- API访问密钥表
CREATE TABLE api_keys (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    key_id VARCHAR(50) NOT NULL COMMENT '密钥ID',
    key_secret VARCHAR(100) NOT NULL COMMENT '密钥值',
    name VARCHAR(100) NOT NULL COMMENT '密钥名称',
    description TEXT COMMENT '密钥描述',
    user_id BIGINT NOT NULL COMMENT '所属用户',
    status ENUM('ACTIVE', 'SUSPENDED', 'EXPIRED') DEFAULT 'ACTIVE',
    permissions JSON COMMENT '权限配置',
    rate_limit JSON COMMENT '限流配置',
    ip_whitelist TEXT COMMENT 'IP白名单',
    expires_at TIMESTAMP COMMENT '过期时间',
    last_used_at TIMESTAMP COMMENT '最后使用时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_key_id (key_id),
    INDEX idx_user_id (user_id),
    INDEX idx_status (status)
);

-- API访问日志表
CREATE TABLE api_access_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    api_id BIGINT NOT NULL COMMENT 'API ID',
    key_id VARCHAR(50) COMMENT '访问密钥',
    user_id BIGINT COMMENT '用户ID',
    client_ip VARCHAR(45) NOT NULL COMMENT '客户端IP',
    user_agent TEXT COMMENT '用户代理',
    method VARCHAR(10) NOT NULL COMMENT 'HTTP方法',
    path VARCHAR(500) NOT NULL COMMENT '请求路径',
    query_params TEXT COMMENT '查询参数',
    request_body LONGTEXT COMMENT '请求体',
    response_status INTEGER NOT NULL COMMENT '响应状态码',
    response_size BIGINT COMMENT '响应大小',
    execution_time INTEGER COMMENT '执行时间(ms)',
    error_message TEXT COMMENT '错误信息',
    accessed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_api_id (api_id),
    INDEX idx_key_id (key_id),
    INDEX idx_user_id (user_id),
    INDEX idx_accessed_at (accessed_at),
    INDEX idx_status (response_status)
);

-- API权限表
CREATE TABLE api_permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    api_id BIGINT NOT NULL COMMENT 'API ID',
    subject_type ENUM('USER', 'ROLE', 'API_KEY') NOT NULL COMMENT '主体类型',
    subject_id BIGINT NOT NULL COMMENT '主体ID',
    permission_type ENUM('READ', 'WRITE', 'DELETE') NOT NULL COMMENT '权限类型',
    conditions JSON COMMENT '权限条件',
    granted_by BIGINT NOT NULL COMMENT '授权人',
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP COMMENT '权限过期时间',
    PRIMARY KEY (api_id, subject_type, subject_id, permission_type),
    FOREIGN KEY (api_id) REFERENCES api_definitions(id) ON DELETE CASCADE,
    INDEX idx_subject (subject_type, subject_id)
);
```

## API接口设计

### API定义管理
```java
@RestController
@RequestMapping("/api/platform/apis")
public class APIDefinitionController {

    // 创建API定义
    @PostMapping
    public ResponseEntity<APIDefinitionVO> createAPI(@RequestBody CreateAPIRequest request);

    // 获取API列表
    @GetMapping
    public ResponseEntity<PageResult<APIDefinitionVO>> getAPIs(
        @RequestParam(defaultValue = "1") int page,
        @RequestParam(defaultValue = "20") int size,
        @RequestParam(required = false) String keyword,
        @RequestParam(required = false) String type,
        @RequestParam(required = false) String status);

    // 获取API详情
    @GetMapping("/{apiId}")
    public ResponseEntity<APIDefinitionDetailVO> getAPI(@PathVariable Long apiId);

    // 更新API定义
    @PutMapping("/{apiId}")
    public ResponseEntity<APIDefinitionVO> updateAPI(
        @PathVariable Long apiId,
        @RequestBody UpdateAPIRequest request);

    // 删除API
    @DeleteMapping("/{apiId}")
    public ResponseEntity<Void> deleteAPI(@PathVariable Long apiId);

    // 测试API
    @PostMapping("/{apiId}/test")
    public ResponseEntity<Object> testAPI(
        @PathVariable Long apiId,
        @RequestBody Map<String, Object> testParams);

    // 发布API
    @PostMapping("/{apiId}/publish")
    public ResponseEntity<Void> publishAPI(@PathVariable Long apiId);

    // 停用API
    @PostMapping("/{apiId}/disable")
    public ResponseEntity<Void> disableAPI(@PathVariable Long apiId);
}
```

### API密钥管理
```java
@RestController
@RequestMapping("/api/platform/keys")
public class APIKeyController {

    // 创建API密钥
    @PostMapping
    public ResponseEntity<APIKeyVO> createKey(@RequestBody CreateAPIKeyRequest request);

    // 获取密钥列表
    @GetMapping
    public ResponseEntity<PageResult<APIKeyVO>> getKeys(
        @RequestParam(defaultValue = "1") int page,
        @RequestParam(defaultValue = "20") int size);

    // 获取密钥详情
    @GetMapping("/{keyId}")
    public ResponseEntity<APIKeyDetailVO> getKey(@PathVariable String keyId);

    // 更新密钥
    @PutMapping("/{keyId}")
    public ResponseEntity<APIKeyVO> updateKey(
        @PathVariable String keyId,
        @RequestBody UpdateAPIKeyRequest request);

    // 重置密钥
    @PostMapping("/{keyId}/reset")
    public ResponseEntity<APIKeyVO> resetKey(@PathVariable String keyId);

    // 停用密钥
    @PostMapping("/{keyId}/suspend")
    public ResponseEntity<Void> suspendKey(@PathVariable String keyId);

    // 启用密钥
    @PostMapping("/{keyId}/activate")
    public ResponseEntity<Void> activateKey(@PathVariable String keyId);

    // 删除密钥
    @DeleteMapping("/{keyId}")
    public ResponseEntity<Void> deleteKey(@PathVariable String keyId);
}
```

### 动态API执行
```java
@RestController
@RequestMapping("/api/v1")
public class DynamicAPIController {

    @Autowired
    private DynamicAPIExecutor apiExecutor;

    @Autowired
    private APIGateway apiGateway;

    // 动态API执行入口
    @RequestMapping("/**")
    public ResponseEntity<Object> executeAPI(HttpServletRequest request) {
        // 构建API请求对象
        APIRequest apiRequest = APIRequest.builder()
            .method(request.getMethod())
            .path(extractPath(request))
            .parameters(extractParameters(request))
            .headers(extractHeaders(request))
            .body(extractBody(request))
            .build();

        // 通过网关处理请求
        return apiGateway.processRequest(apiRequest);
    }

    // 获取API文档
    @GetMapping("/docs/{apiId}")
    public ResponseEntity<Object> getAPIDoc(@PathVariable Long apiId) {
        APIDefinition apiDef = apiService.getById(apiId);
        OpenAPISpec spec = generateOpenAPISpec(apiDef);
        return ResponseEntity.ok(spec);
    }
}
```

## 前端页面设计

### API管理主页
```vue
<template>
  <div class="api-platform">
    <!-- 头部操作区 -->
    <div class="platform-header">
      <div class="header-actions">
        <el-button type="primary" @click="createAPI">
          <el-icon><Plus /></el-icon>
          创建API
        </el-button>
        <el-button @click="importAPI">导入API</el-button>
        <el-button @click="exportAPIs">批量导出</el-button>
      </div>

      <!-- 搜索和筛选 -->
      <div class="search-filters">
        <el-input
          v-model="searchKeyword"
          placeholder="搜索API..."
          @keyup.enter="searchAPIs"
          clearable
        >
          <template #prefix>
            <el-icon><Search /></el-icon>
          </template>
        </el-input>

        <el-select v-model="statusFilter" placeholder="状态筛选" clearable>
          <el-option label="全部" value="" />
          <el-option label="草稿" value="DRAFT" />
          <el-option label="已发布" value="ACTIVE" />
          <el-option label="已废弃" value="DEPRECATED" />
          <el-option label="已停用" value="DISABLED" />
        </el-select>

        <el-select v-model="typeFilter" placeholder="类型筛选" clearable>
          <el-option label="全部" value="" />
          <el-option label="数据表" value="TABLE" />
          <el-option label="自定义SQL" value="CUSTOM_SQL" />
          <el-option label="文件数据" value="FILE" />
          <el-option label="聚合查询" value="AGGREGATION" />
        </el-select>
      </div>
    </div>

    <!-- API列表 -->
    <div class="api-list">
      <el-table :data="apis" style="width: 100%" @row-click="viewAPI">
        <el-table-column prop="name" label="API名称" min-width="200">
          <template #default="{ row }">
            <div class="api-name">
              <el-icon class="api-icon">
                <component :is="getAPIIcon(row.type)" />
              </el-icon>
              <span>{{ row.name }}</span>
            </div>
          </template>
        </el-table-column>

        <el-table-column prop="path" label="API路径" min-width="250">
          <template #default="{ row }">
            <el-tag :type="getMethodColor(row.method)" size="small">{{ row.method }}</el-tag>
            <code class="api-path">{{ row.path }}</code>
          </template>
        </el-table-column>

        <el-table-column prop="status" label="状态" width="100">
          <template #default="{ row }">
            <APIStatus :status="row.status" />
          </template>
        </el-table-column>

        <el-table-column prop="version" label="版本" width="80" />

        <el-table-column prop="callCount" label="调用次数" width="100" align="right">
          <template #default="{ row }">
            {{ formatNumber(row.callCount) }}
          </template>
        </el-table-column>

        <el-table-column prop="updatedAt" label="更新时间" width="160">
          <template #default="{ row }">
            {{ formatDateTime(row.updatedAt) }}
          </template>
        </el-table-column>

        <el-table-column label="操作" width="200" fixed="right">
          <template #default="{ row }">
            <el-button size="small" @click.stop="testAPI(row)">测试</el-button>
            <el-button size="small" @click.stop="viewDocs(row)">文档</el-button>
            <el-dropdown @command="(cmd) => handleCommand(cmd, row)" @click.stop>
              <el-button size="small">
                更多 <el-icon><ArrowDown /></el-icon>
              </el-button>
              <template #dropdown>
                <el-dropdown-menu>
                  <el-dropdown-item command="edit">编辑</el-dropdown-item>
                  <el-dropdown-item command="clone">克隆</el-dropdown-item>
                  <el-dropdown-item command="permissions">权限管理</el-dropdown-item>
                  <el-dropdown-item command="logs">访问日志</el-dropdown-item>
                  <el-dropdown-item command="export">导出</el-dropdown-item>
                  <el-dropdown-item command="delete" divided>删除</el-dropdown-item>
                </el-dropdown-menu>
              </template>
            </el-dropdown>
          </template>
        </el-table-column>
      </el-table>

      <!-- 分页 -->
      <el-pagination
        v-model:current-page="currentPage"
        :total="totalCount"
        :page-size="pageSize"
        layout="prev, pager, next, sizes, total"
        @current-change="onPageChange"
        @size-change="onSizeChange"
      />
    </div>
  </div>
</template>
```

### API创建/编辑页面
```vue
<template>
  <div class="api-editor">
    <el-form ref="apiForm" :model="apiForm" :rules="formRules" label-width="120px">
      <!-- 基本信息 -->
      <el-card title="基本信息">
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="API名称" prop="name">
              <el-input v-model="apiForm.name" placeholder="请输入API名称" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="API版本" prop="version">
              <el-input v-model="apiForm.version" placeholder="如: 1.0.0" />
            </el-form-item>
          </el-col>
        </el-row>

        <el-row :gutter="20">
          <el-col :span="8">
            <el-form-item label="HTTP方法" prop="method">
              <el-select v-model="apiForm.method" placeholder="选择方法">
                <el-option label="GET" value="GET" />
                <el-option label="POST" value="POST" />
                <el-option label="PUT" value="PUT" />
                <el-option label="DELETE" value="DELETE" />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="16">
            <el-form-item label="API路径" prop="path">
              <el-input v-model="apiForm.path" placeholder="/api/v1/users" />
            </el-form-item>
          </el-col>
        </el-row>

        <el-form-item label="描述" prop="description">
          <el-input
            v-model="apiForm.description"
            type="textarea"
            :rows="3"
            placeholder="请输入API描述"
          />
        </el-form-item>
      </el-card>

      <!-- 数据源配置 -->
      <el-card title="数据源配置">
        <el-form-item label="API类型" prop="type">
          <el-radio-group v-model="apiForm.type" @change="onTypeChange">
            <el-radio-button label="TABLE">数据表</el-radio-button>
            <el-radio-button label="CUSTOM_SQL">自定义SQL</el-radio-button>
            <el-radio-button label="FILE">文件数据</el-radio-button>
            <el-radio-button label="AGGREGATION">聚合查询</el-radio-button>
          </el-radio-group>
        </el-form-item>

        <!-- 数据表配置 -->
        <template v-if="apiForm.type === 'TABLE'">
          <TableAPIConfig v-model="apiForm.dataSourceConfig" />
        </template>

        <!-- 自定义SQL配置 -->
        <template v-if="apiForm.type === 'CUSTOM_SQL'">
          <CustomSQLConfig v-model="apiForm.dataSourceConfig" />
        </template>

        <!-- 文件配置 -->
        <template v-if="apiForm.type === 'FILE'">
          <FileAPIConfig v-model="apiForm.dataSourceConfig" />
        </template>
      </el-card>

      <!-- 参数配置 -->
      <el-card title="参数配置">
        <ParameterConfig v-model="apiForm.parameters" />
      </el-card>

      <!-- 安全配置 -->
      <el-card title="安全配置">
        <SecurityConfig v-model="apiForm.securityConfig" />
      </el-card>

      <!-- 缓存配置 -->
      <el-card title="缓存配置">
        <CacheConfig v-model="apiForm.cacheConfig" />
      </el-card>
    </el-form>

    <!-- 操作按钮 -->
    <div class="form-actions">
      <el-button @click="cancel">取消</el-button>
      <el-button @click="saveAsDraft">保存草稿</el-button>
      <el-button type="primary" @click="testAPI">测试API</el-button>
      <el-button type="primary" @click="saveAndPublish">保存并发布</el-button>
    </div>

    <!-- API测试弹窗 -->
    <APITestDialog
      v-model:visible="testDialogVisible"
      :api-definition="apiForm"
      @test-result="onTestResult"
    />
  </div>
</template>
```

## 实现计划

### Phase 1: 核心框架 (2天)
- 搭建API网关和动态执行框架
- 实现API定义模型和基础CRUD
- 开发API密钥管理系统

### Phase 2: API生成器 (2天)
- 实现数据表API自动生成
- 开发自定义SQL API包装
- 添加参数验证和响应格式化

### Phase 3: 文档和测试 (2天)
- 集成OpenAPI/Swagger文档生成
- 开发在线API测试工具
- 实现API版本管理

### Phase 4: 权限和监控 (1天)
- 完善权限控制系统
- 添加访问日志和监控
- 实现限流和缓存机制

## 验收标准

1. **功能完整性**
   - API自动生成功能完整
   - 文档系统完善易用
   - 权限控制精确可靠

2. **性能要求**
   - API响应时间 < 100ms
   - 支持高并发访问
   - 限流和缓存有效

3. **安全性要求**
   - 认证机制安全可靠
   - 权限控制严格准确
   - 访问日志完整详细

4. **用户体验**
   - API文档清晰完整
   - 测试工具便捷好用
   - 管理界面友好直观