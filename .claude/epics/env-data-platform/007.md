---
name: 监控告警系统
status: open
created: 2025-09-16T08:20:41Z
updated: 2025-09-16T08:20:41Z
github: [Will be updated when synced to GitHub]
depends_on: [001]
parallel: true
---

# Task 007: 监控告警系统

## 概述
实现基于Prometheus + Grafana的全栈监控告警系统，提供实时监控、智能告警和日志分析能力。

## 核心功能

### 1. 指标监控
- **系统指标**: CPU、内存、磁盘、网络使用率
- **应用指标**: API响应时间、错误率、吞吐量
- **业务指标**: 数据采集频率、处理延迟、存储增长
- **数据库指标**: 连接数、查询性能、事务统计

### 2. 告警规则
```yaml
# prometheus/rules/env-platform.yml
groups:
  - name: env-platform-alerts
    rules:
      - alert: HighAPIErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "API错误率过高"
          description: "{{ $labels.service }}服务错误率超过10%"

      - alert: DataCollectionDelay
        expr: time() - env_data_last_collection_timestamp > 300
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "数据采集延迟"
          description: "环境数据采集延迟超过5分钟"
```

### 3. 监控面板
```json
{
  "dashboard": {
    "title": "环境数据平台监控",
    "panels": [
      {
        "title": "系统概览",
        "targets": [
          {
            "expr": "up{job=\"env-platform\"}"
          }
        ]
      },
      {
        "title": "API性能",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))"
          }
        ]
      },
      {
        "title": "数据质量",
        "targets": [
          {
            "expr": "env_data_quality_score"
          }
        ]
      }
    ]
  }
}
```

## 技术架构

### 1. 监控堆栈
```yaml
# docker-compose.monitoring.yml
version: '3.8'
services:
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./prometheus/rules:/etc/prometheus/rules
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-storage:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources

  alertmanager:
    image: prom/alertmanager:latest
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml

volumes:
  grafana-storage:
```

### 2. 应用指标集成
```go
// pkg/monitoring/metrics.go
package monitoring

import (
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promauto"
)

var (
    httpRequestsTotal = promauto.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "总HTTP请求数",
        },
        []string{"method", "endpoint", "status"},
    )

    httpRequestDuration = promauto.NewHistogramVec(
        prometheus.HistogramOpts{
            Name: "http_request_duration_seconds",
            Help: "HTTP请求持续时间",
            Buckets: prometheus.DefBuckets,
        },
        []string{"method", "endpoint"},
    )

    dataCollectionTimestamp = promauto.NewGauge(
        prometheus.GaugeOpts{
            Name: "env_data_last_collection_timestamp",
            Help: "最后数据采集时间戳",
        },
    )

    dataQualityScore = promauto.NewGaugeVec(
        prometheus.GaugeOpts{
            Name: "env_data_quality_score",
            Help: "数据质量评分",
        },
        []string{"sensor_type", "location"},
    )
)

func RecordHTTPRequest(method, endpoint, status string, duration float64) {
    httpRequestsTotal.WithLabelValues(method, endpoint, status).Inc()
    httpRequestDuration.WithLabelValues(method, endpoint).Observe(duration)
}

func UpdateDataCollectionTimestamp() {
    dataCollectionTimestamp.SetToCurrentTime()
}

func SetDataQualityScore(sensorType, location string, score float64) {
    dataQualityScore.WithLabelValues(sensorType, location).Set(score)
}
```

### 3. 日志聚合
```yaml
# logging/filebeat.yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/env-platform/*.log
  fields:
    service: env-platform
  fields_under_root: true

- type: docker
  containers.ids: '*'
  processors:
  - add_docker_metadata: ~

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "env-platform-%{+yyyy.MM.dd}"

logging.level: info
```

## 告警通知

### 1. 告警管理器配置
```yaml
# alertmanager/alertmanager.yml
global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@env-platform.com'

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default'
  routes:
  - match:
      severity: critical
    receiver: 'critical-alerts'

receivers:
- name: 'default'
  email_configs:
  - to: 'admin@env-platform.com'
    subject: '环境平台告警: {{ .GroupLabels.alertname }}'
    body: |
      {{ range .Alerts }}
      告警: {{ .Annotations.summary }}
      描述: {{ .Annotations.description }}
      时间: {{ .StartsAt }}
      {{ end }}

- name: 'critical-alerts'
  email_configs:
  - to: 'critical@env-platform.com'
    subject: '【紧急】环境平台严重告警'
  webhook_configs:
  - url: 'http://webhook-service:8080/alerts'
    send_resolved: true
```

### 2. 微信告警集成
```go
// pkg/alerting/wechat.go
package alerting

import (
    "bytes"
    "encoding/json"
    "fmt"
    "net/http"
)

type WeChatAlert struct {
    MsgType string `json:"msgtype"`
    Text    struct {
        Content string `json:"content"`
    } `json:"text"`
}

func SendWeChatAlert(webhook string, alert Alert) error {
    msg := WeChatAlert{
        MsgType: "text",
    }
    msg.Text.Content = fmt.Sprintf(
        "环境平台告警\n告警: %s\n描述: %s\n时间: %s",
        alert.Summary,
        alert.Description,
        alert.StartsAt.Format("2006-01-02 15:04:05"),
    )

    jsonData, err := json.Marshal(msg)
    if err != nil {
        return err
    }

    resp, err := http.Post(webhook, "application/json", bytes.NewBuffer(jsonData))
    if err != nil {
        return err
    }
    defer resp.Body.Close()

    return nil
}
```

## 性能监控

### 1. APM集成
```go
// pkg/apm/tracer.go
package apm

import (
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/trace"
    "go.opentelemetry.io/otel/exporters/jaeger"
    "go.opentelemetry.io/otel/sdk/trace"
)

func InitTracer() (trace.TracerProvider, error) {
    exp, err := jaeger.New(jaeger.WithCollectorEndpoint(
        jaeger.WithEndpoint("http://jaeger:14268/api/traces"),
    ))
    if err != nil {
        return nil, err
    }

    tp := trace.NewTracerProvider(
        trace.WithBatcher(exp),
        trace.WithResource(resource.NewWithAttributes(
            semconv.SchemaURL,
            semconv.ServiceNameKey.String("env-platform"),
        )),
    )

    otel.SetTracerProvider(tp)
    return tp, nil
}
```

### 2. 自定义指标
```go
// pkg/metrics/custom.go
package metrics

import (
    "context"
    "time"
)

type MetricsCollector struct {
    prometheus *prometheus.Registry
}

func (m *MetricsCollector) CollectCustomMetrics(ctx context.Context) {
    ticker := time.NewTicker(30 * time.Second)
    defer ticker.Stop()

    for {
        select {
        case <-ticker.C:
            m.collectDatabaseMetrics()
            m.collectBusinessMetrics()
            m.collectResourceMetrics()
        case <-ctx.Done():
            return
        }
    }
}

func (m *MetricsCollector) collectDatabaseMetrics() {
    // 数据库连接池指标
    // 查询性能指标
    // 存储使用率指标
}

func (m *MetricsCollector) collectBusinessMetrics() {
    // 数据处理延迟
    // 告警触发频率
    // 用户活跃度
}
```

## 国产化兼容

### 1. 麒麟系统适配
```bash
# scripts/install-monitoring-kylin.sh
#!/bin/bash
# 麒麟系统监控组件安装脚本

# 检查系统版本
if [[ $(uname -a) =~ "Kylin" ]]; then
    echo "检测到麒麟系统，使用国产化配置"

    # 使用国产镜像源
    sed -i 's|docker.io|registry.cn-hangzhou.aliyuncs.com|g' docker-compose.monitoring.yml

    # 调整资源限制
    export PROMETHEUS_MEMORY_LIMIT=1Gi
    export GRAFANA_MEMORY_LIMIT=512Mi
fi

docker-compose -f docker-compose.monitoring.yml up -d
```

### 2. 信创数据库支持
```yaml
# prometheus/prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'env-platform'
    static_configs:
      - targets: ['app:8080']

  - job_name: 'kingbase'  # 人大金仓数据库
    static_configs:
      - targets: ['kingbase-exporter:9187']

  - job_name: 'dameng'    # 达梦数据库
    static_configs:
      - targets: ['dameng-exporter:9188']
```

## 实施计划

### 第1天: 基础监控搭建
- [ ] 部署Prometheus和Grafana
- [ ] 配置基础系统指标采集
- [ ] 创建初始监控面板

### 第2天: 应用监控集成
- [ ] 集成应用指标收集
- [ ] 配置APM追踪
- [ ] 设置日志聚合

### 第3天: 告警系统配置
- [ ] 配置Alertmanager
- [ ] 设置告警规则
- [ ] 集成通知渠道

### 第4天: 自定义监控
- [ ] 实现业务指标监控
- [ ] 配置数据质量监控
- [ ] 优化监控性能

### 第5天: 国产化适配
- [ ] 信创环境测试
- [ ] 性能调优
- [ ] 文档编写

## 交付物
- [ ] 完整监控系统部署
- [ ] 监控面板和告警规则
- [ ] 运维手册和故障排除指南
- [ ] 监控系统性能测试报告

## 验收标准
- 系统监控覆盖率达到95%以上
- 告警响应时间小于1分钟
- 监控数据保留期不少于30天
- 支持信创环境部署